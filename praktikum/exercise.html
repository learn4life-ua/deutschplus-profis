<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Вправа — Deutsch+Profis</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" />
<style>
:root{--green:#009846;--green-light:#e6f5f0;--dark:#1f2937;--muted:#6b7280;--bg:#f9fafb;--card-bg:#fff;--border-color:#e5e7eb;--radius:16px;--shadow:0 4px 6px -1px rgba(0,0,0,.03),0 2px 4px -2px rgba(0,0,0,.03);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.05),0 4px 6px -4px rgba(0,0,0,.05);--transition:all .25s cubic-bezier(.4,0,.2,1)}
body{margin:0;background:var(--bg);color:#374151;font-family:'Inter',system-ui,sans-serif;line-height:1.6}
.wrap{box-sizing:border-box;max-width:800px;margin:0 auto;padding:0 clamp(16px,5vw,24px)}
.main-nav{position:sticky;top:16px;margin:16px clamp(16px,5vw,24px) 0;z-index:50;background:rgba(255,255,255,.85);backdrop-filter:blur(10px);border:1px solid var(--border-color);border-radius:16px;padding:12px 24px;box-shadow:var(--shadow-lg)}
.main-nav .nav-content{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto}
.logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:18px;color:var(--dark);text-decoration:none}
.logo svg{color:var(--green)}
h1{text-align:center;font-size:clamp(24px,3.5vw,30px);color:var(--dark);margin:28px 0 8px}
.lead{text-align:center;color:var(--muted);max-width:600px;margin:0 auto 24px}
.section{background:var(--card-bg);border:1px solid var(--border-color);border-radius:var(--radius);padding:clamp(20px,5vw,28px);margin:0 0 20px}
.section h2{font-size:20px;margin:0 0 12px;color:var(--dark);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:10px}
.score{font-size:12px;color:var(--muted)}
.inline-input,.vocab-input,textarea{width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;background:var(--bg);font-family:inherit;font-size:1rem}
.inline-input{display:inline-block;width:170px;text-align:center;font-weight:600}
#vocabulary-exercise{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(250px,1fr))}
.vocab-item{display:flex;flex-direction:column;gap:6px}
.vocab-item label{font-weight:500}
.d-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;text-decoration:none;border:1px solid var(--border-color);padding:12px 20px;border-radius:12px;font-weight:700;background:var(--card-bg);transition:var(--transition)}
.d-btn:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);border-color:var(--green);color:var(--green)}
.primary{background:var(--green);color:#fff;border-color:transparent}
.primary:hover{color:#fff}
.page-nav{display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-top:20px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal.active{display:flex}
.modal-content{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow:auto;padding:20px}
.footer{text-align:center;color:var(--muted);font-size:14px;padding:40px 0}
</style>
</head>
<body>
<nav class="main-nav">
  <div class="nav-content">
    <a href="index.html" class="logo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
      Deutsch<span style="color:var(--green)">+</span>Profis
    </a>
  </div>
</nav>

<main>
  <section style="padding: clamp(32px,7vw,48px) 0;">
    <div class="wrap">
      <h1 id="page-title">Вправа</h1>
      <p class="lead" id="page-sub">Переклад, словничок і запитання на розуміння</p>

      <div class="section">
        <h2>1. Текст для перекладу <span id="translation-score" class="score"></span></h2>
        <h3 id="germanTextTitle" style="margin:0 0 8px"></h3>
        <p id="germanTextContent" style="background:var(--bg);padding:12px;border-radius:8px"></p>
        <p id="textExplanation" style="font-style:italic;color:var(--muted)"></p>
        <textarea id="translationInput" rows="7" placeholder="Введіть свій переклад тут…"></textarea>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="checkTranslationBtn" class="d-btn primary">Перевірити</button>
          <button id="showSampleBtn" class="d-btn">Показати зразок перекладу</button>
        </div>
      </div>

      <div class="section">
        <h2>2. Словникові вправи <span id="vocabulary-score" class="score"></span></h2>
        <p>Введіть українські відповідники для слів.</p>
        <div id="vocabulary-exercise"></div>
        <button id="checkVocabBtn" class="d-btn primary" style="margin-top:12px">Перевірити словник</button>
      </div>

      <div class="section">
        <h2>3. Вправи на розуміння <span id="comprehension-score" class="score"></span></h2>
        <h3 style="margin:0 0 12px;border:none">3.1. Доповніть речення</h3>
        <div id="comprehension-exercise-3" style="display:grid;gap:14px"></div>
        <h3 style="margin:18px 0 12px;border:none">3.2. Відповіді на запитання</h3>
        <div id="comprehension-exercise-4" style="display:grid;gap:14px"></div>
        <button id="checkComprehensionBtn" class="d-btn primary" style="margin-top:12px">Перевірити розуміння</button>
      </div>

      <div class="page-nav">
        <a class="d-btn" href="index.html">← До списку вправ</a>
        <a class="d-btn" id="next-link" href="#">Наступна вправа →</a>
      </div>
    </div>
  </section>
</main>

<div id="resultModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle" style="margin:0 0 12px">Результати</h3>
    <div id="modalContent"></div>
    <div style="margin-top:16px;display:flex;justify-content:flex-end">
      <button id="closeModalBtn" class="d-btn primary">Гаразд</button>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="wrap">© 2025 Deutsch+Profis • ВСП «АЕФК ПДАУ»</div>
</footer>

<script>
const $ = sel => document.querySelector(sel);
const els = {
  title: $('#page-title'), sub: $('#page-sub'),
  gTitle: $('#germanTextTitle'), gText: $('#germanTextContent'),
  expl: $('#textExplanation'), tr: $('#translationInput'),
  vWrap: $('#vocabulary-exercise'), c31: $('#comprehension-exercise-3'), c32: $('#comprehension-exercise-4'),
  sTr: $('#translation-score'), sVoc: $('#vocabulary-score'), sComp: $('#comprehension-score'),
  btnTr: $('#checkTranslationBtn'), btnSample: $('#showSampleBtn'), btnVoc: $('#checkVocabBtn'), btnComp: $('#checkComprehensionBtn'),
  modal: $('#resultModal'), mTitle: $('#modalTitle'), mCont: $('#modalContent'), mClose: $('#closeModalBtn'),
  next: $('#next-link')
};

const qs = new URLSearchParams(location.search);
const vid = (qs.get('v') || '01').padStart(2,'0');
const dataURL = `data/${vid}.json`;

const key = v => `dp-praktikum-${v}`;
const esc = s => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const norm = s => s.toLowerCase().replaceAll('ß','ss').normalize('NFKD').replace(/[̀-\u036f]/g,'').replace(/\s+/g,' ').trim();
const stripHyphens = s => s.replace(/-/g,'');
const keywords = s => !s ? [] : norm(s).split(/[^a-zа-щьюяїієґ0-9\-]+/i)
  .filter(w => w.length >= 4 && !['sind','werden','auch','dass','weil','oder','und','mit','der','die','das','den','dem','des','ein','eine','einer','eines','einem','einen','von','für','im','in','an','am','auf','zu','zum','zur','та','і','або','але','що','які','яка','який','для','від','про','над','під','через','при','це','той','такий'].includes(w));

const showModal = (t, html) => { els.mTitle.textContent = t; els.mCont.innerHTML = html; els.modal.classList.add('active'); };
const hideModal = () => els.modal.classList.remove('active');
els.mClose.addEventListener('click', hideModal);
els.modal.addEventListener('click', e => { if(e.target === els.modal) hideModal(); });
document.addEventListener('keydown', e => { if(e.key==='Escape') hideModal(); });

const scores = { vocab:0, c31:0, c32:0 };
const updateOverall = () => {
  const comp = (scores.c31 + scores.c32)/2;
  const overall = ((scores.vocab + comp)/2).toFixed(0);
  els.sVoc.textContent = scores.vocab ? `${scores.vocab.toFixed(0)}%` : '';
  els.sComp.textContent = (comp>0) ? `${comp.toFixed(0)}%` : '';
  document.querySelector('#overallPercentage')?.textContent = `${overall}%`;
};

const saveAnswers = () => {
  const data = {
    tr: els.tr.value,
    voc: Array.from(document.querySelectorAll('.vocab-input')).map(i => i.value),
    c31: Array.from(document.querySelectorAll('.comp3-1-input')).map(i => i.value),
    c32: Array.from(document.querySelectorAll('.comp3-2-input')).map(i => i.value),
  };
  try{ localStorage.setItem(key(vid), JSON.stringify(data)); }catch(_){}
};
document.addEventListener('input', e=>{
  if(!e.target.matches('textarea,.vocab-input,.comp3-1-input,.comp3-2-input')) return;
  saveAnswers();
});

fetch(dataURL).then(r=>r.json()).then(data=>{
  // Header
  els.title.textContent = data.pageTitle || 'Вправа';
  els.sub.textContent = data.pageSub || 'Переклад, словничок і запитання на розуміння';
  els.gTitle.textContent = data.title || '';
  els.gText.innerHTML = data.germanText || '';
  els.expl.textContent = data.explanation || '';

  // Vocab
  els.vWrap.innerHTML = (data.vocabulary||[]).map((it,idx)=>`
    <div class="vocab-item">
      <label for="voc-${idx}">${it.word}</label>
      <input id="voc-${idx}" class="vocab-input" type="text" data-answer="${it.answer}">
    </div>
  `).join('');

  // 3.1
  els.c31.innerHTML = (data.comprehension3_1||[]).map(item=>{
    let i=0;
    const html = item.textParts.map(p => p==="INPUT"
      ? `<input type="text" class="inline-input comp3-1-input" data-answer="${item.answers[i++]}">`
      : `<span>${p}</span>`).join('');
    return `<div style="background:var(--bg);padding:10px;border-radius:8px"><p>${html}</p></div>`;
  }).join('');

  // 3.2
  els.c32.innerHTML = (data.comprehension3_2||[]).map(it=>`
    <div style="display:flex;flex-direction:column;gap:6px;">
      <label>${it.question}</label>
      <textarea class="comp3-2-input" rows="2" data-answer="${it.answer}"></textarea>
    </div>
  `).join('');

  // Next link
  const n = String(Math.min(14, Number(vid)+1)).padStart(2,'0');
  els.next.href = (vid==='14') ? 'index.html' : `exercise.html?v=${n}`;
  els.next.textContent = (vid==='14') ? 'До списку вправ' : 'Наступна вправа →';

  // Restore
  const saved = localStorage.getItem(key(vid));
  if(saved){
    const a = JSON.parse(saved);
    els.tr.value = a.tr || '';
    document.querySelectorAll('.vocab-input').forEach((inp,i)=> inp.value = a.voc?.[i] || '');
    document.querySelectorAll('.comp3-1-input').forEach((inp,i)=> inp.value = a.c31?.[i] || '');
    document.querySelectorAll('.comp3-2-input').forEach((inp,i)=> inp.value = a.c32?.[i] || '');
  }
});

// Buttons
els.btnSample.addEventListener('click', async ()=>{
  const data = await (await fetch(dataURL)).json();
  const tpl = data.correctTranslation || '';
  const box = `<div style="white-space:pre-wrap;background:var(--green-light);padding:12px;border-radius:8px">${tpl.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}</div>`;
  showModal('Зразок перекладу', box);
});

els.btnTr.addEventListener('click', ()=>{
  const user = els.tr.value.trim();
  const safe = user ? user.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') : '<i>(Відповідь відсутня)</i>';
  showModal('Ваш переклад', `<div style="white-space:pre-wrap;background:var(--bg);padding:12px;border-radius:8px">${safe}</div>`);
  els.sTr.textContent = 'Самоперевірка';
});

els.btnVoc.addEventListener('click', ()=>{
  const inputs = document.querySelectorAll('.vocab-input');
  let ok=0, details='<ul style="list-style:none;padding-left:0;display:grid;gap:8px">';
  inputs.forEach(inp=>{
    const user = norm(inp.value);
    const answers = inp.dataset.answer.split(',').map(a=>norm(a));
    const isRight = answers.some(a=> a && (user===a || user.includes(a) || a.includes(user)));
    const gold = inp.dataset.answer.split(',').map(a=>`<code>${a.trim().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}</code>`).join(', ');
    if(isRight){ ok++; details+=`<li>✅ <b>${inp.previousElementSibling?.textContent||''}</b> — ${inp.value.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}</li>`; }
    else { details+=`<li>❌ <b>${inp.previousElementSibling?.textContent||''}</b><br>Ваша: “${(inp.value||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}”<br>Приклад: ${gold}</li>`; }
  });
  details+='</ul>';
  const score = inputs.length ? (ok/inputs.length)*100 : 0;
  scores.vocab = score;
  showModal('Результати словникової вправи', `<p><b>Правильно:</b> ${ok} з ${inputs.length} (${score.toFixed(0)}%)</p>${details}`);
  updateOverall();
});

els.btnComp.addEventListener('click', ()=>{
  // 3.1: точна відповідність (без дефісів)
  const i31 = document.querySelectorAll('.comp3-1-input');
  let c31=0;
  i31.forEach(inp=>{
    const u = stripHyphens(norm(inp.value));
    const g = stripHyphens(norm(inp.dataset.answer));
    if(u===g) c31++;
  });
  scores.c31 = i31.length ? (c31/i31.length)*100 : 0;

  // 3.2: ключові слова
  const i32 = document.querySelectorAll('.comp3-2-input');
  let c32=0;
  i32.forEach(inp=>{
    const gold = keywords(inp.dataset.answer);
    const said = keywords(inp.value);
    const hits = said.filter(w=>gold.includes(w)).length;
    if(said.length>0 && hits>=Math.min(2,gold.length)) c32++;
  });
  scores.c32 = i32.length ? (c32/i32.length)*100 : 0;

  showModal('Результати розуміння', `
    <p>3.1 (доповнення): ${c31} з ${i31.length}</p>
    <p>3.2 (відповіді): ${c32} з ${i32.length}</p>
  `);
  updateOverall();
});
</script>
</body>
</html>
