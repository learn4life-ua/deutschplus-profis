<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Вправа — Deutsch+Profis</title>
<meta name="theme-color" content="#009846" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet" />
<style>
:root{
  --green:#009846;--green-light:#e6f5f0;--dark:#1f2937;--muted:#6b7280;
  --bg:#f9fafb;--card:#fff;--border:#e5e7eb;--r:16px;
  --sh:0 4px 6px -1px rgba(0,0,0,.03),0 2px 4px -2px rgba(0,0,0,.03);
  --sh-lg:0 10px 15px -3px rgba(0,0,0,.05),0 4px 6px -4px rgba(0,0,0,.05);
  --t:all .25s cubic-bezier(.4,0,.2,1);
}
html{scroll-behavior:smooth}
body{margin:0;background:var(--bg);color:#374151;font-family:Inter,system-ui,sans-serif;line-height:1.6}
.wrap{box-sizing:border-box;max-width:800px;margin:0 auto;padding:0 clamp(16px,5vw,24px)}
h1{font-size:clamp(28px,4vw,36px);text-align:center;color:var(--dark);margin:24px 0 8px}
.lead{font-size:clamp(16px,2vw,18px);color:var(--muted);max-width:640px;margin:0 auto 28px;text-align:center}
.section{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:clamp(20px,4vw,28px);margin:16px 0}
.section h2{font-size:22px;margin:0 0 14px;padding-bottom:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.score{font-size:.85em;color:var(--muted)}
.badge{display:inline-flex;width:14px;height:14px;border-radius:50%;background:#e5e7eb;margin-left:8px}
.pill{display:inline-block;background:#eef2f7;border:1px solid var(--border);border-radius:999px;padding:2px 10px;font-size:12px;color:var(--muted)}
.card{background:var(--bg);padding:14px;border-radius:12px;border:1px solid var(--border)}
textarea,.input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#f3f4f6;font:inherit}
textarea:focus,.input:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(0,152,70,.12)}
.inline-input{display:inline-block;width:170px;text-align:center;font-weight:600}
#vocab{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
.v-item{display:flex;flex-direction:column;gap:8px}
.d-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
  cursor:pointer;text-decoration:none;border:1px solid var(--border);padding:10px 18px;border-radius:12px;
  font-weight:700;background:var(--card);transition:var(--t);color:var(--dark)}
.d-btn--primary{background:var(--green);border-color:transparent;color:#fff}
.d-btn:hover{transform:translateY(-2px);box-shadow:var(--sh-lg)}
.main-nav{position:sticky;top:16px;margin:16px clamp(16px,5vw,24px) 0;z-index:50;background:rgba(255,255,255,.85);
  backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:12px 18px;box-shadow:var(--sh-lg)}
.nav-content{display:flex;justify-content:space-between;align-items:center;max-width:1100px;margin:0 auto}
.logo{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--dark);text-decoration:none}
.logo svg{color:var(--green)}
.footer{text-align:center;color:var(--muted);font-size:14px;padding:40px 0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal.active{display:flex}
.modal .box{background:#fff;border-radius:16px;max-width:640px;width:100%;max-height:90vh;overflow:auto;padding:22px}
.modal .box h3{margin:0 0 10px}
.modal code{background:var(--bg);border:1px solid var(--border);padding:2px 6px;border-radius:6px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<nav class="main-nav">
  <div class="nav-content">
    <a href="index.html" class="logo">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
      </svg>
      Deutsch<span style="color:var(--green)">+</span>Profis
    </a>
    <span id="crumb" class="pill">Вправа <span id="v-num">—</span></span>
  </div>
</nav>

<main class="wrap">
  <h1 id="title">Вправа</h1>
  <p class="lead">Переклад, словничок і запитання на розуміння</p>

  <!-- 1 -->
  <section class="section">
    <h2>1. Текст для перекладу <span id="score-translation" class="score"></span></h2>
    <div class="card" id="germanText"></div>
    <p id="explanation" class="small" style="margin-top:10px"></p>
    <textarea id="translationInput" rows="7" placeholder="Введіть свій переклад тут…"></textarea>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="checkTranslationBtn" class="d-btn d-btn--primary">Перевірити переклад</button>
      <button id="copyGermanBtn" class="d-btn" title="Скопіювати німецький текст">Копіювати текст</button>
    </div>
  </section>

  <!-- 2 -->
  <section class="section">
    <h2>2. Словникові вправи <span id="score-vocab" class="score"></span></h2>
    <p class="small">Введіть українські відповідники.</p>
    <div id="vocab"></div>
    <button id="checkVocabBtn" class="d-btn d-btn--primary" style="margin-top:12px">Перевірити словник</button>
  </section>

  <!-- 3 -->
  <section class="section">
    <h2>3. Вправи на розуміння <span id="score-comp" class="score"></span></h2>
    <h3 style="margin:0 0 10px;border:none">3.1. Доповніть речення</h3>
    <div id="comp31" style="display:grid;gap:14px"></div>

    <h3 style="margin:16px 0 10px;border:none">3.2. Дайте відповіді на запитання</h3>
    <div id="comp32" style="display:grid;gap:14px"></div>

    <button id="checkCompBtn" class="d-btn d-btn--primary" style="margin-top:12px">Перевірити розуміння</button>
  </section>

  <section class="section">
    <div>Загальний бал: <b id="overall">0%</b></div>
    <div class="small">Ваша робота зберігається локально на цьому пристрої.</div>
  </section>

  <div class="footer">
    <p>© 2025 Deutsch+Profis • ВСП «АЕФК ПДАУ». Усі права захищені.</p>
    <p><a href="index.html" class="d-btn">← На головну</a></p>
  </div>
</main>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
  <div class="box">
    <h3 id="m-title">Результати</h3>
    <div id="m-body"></div>
    <button id="m-close" class="d-btn d-btn--primary" style="width:100%;margin-top:16px">Закрити</button>
  </div>
</div>

<script defer>
/* ---------- helpers ---------- */
const qs = (k, d=null) => new URLSearchParams(location.search).get(k) ?? d;
const pad2 = n => String(n).padStart(2,'0');
const escapeHTML = s => s.toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
const norm = s => (s||'').toLowerCase().replaceAll('ß','ss').normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim();
const normStrict = s => norm(s).replace(/-/g,''); // for exact blanks
const keyWords = s => {
  if(!s) return [];
  const stop = new Set(['sind','werden','auch','dass','weil','oder','und','mit','der','die','das','den','dem','des','ein','eine','einer','einem','einen','von','für','im','in','an','am','auf','zu','zum','zur','та','і','або','але','що','які','яка','який','для','від','про','над','під','через','при','це','той','такий']);
  return norm(s).split(/[^a-zа-щьюяїієґ0-9\-]+/i).filter(w => w.length>=4 && !stop.has(w));
};
const showModal = (title, html) => {
  document.getElementById('m-title').textContent = title;
  document.getElementById('m-body').innerHTML = html;
  document.getElementById('modal').classList.add('active');
};
const hideModal = () => document.getElementById('modal').classList.remove('active');

/* ---------- state ---------- */
const state = { id: 1, scores: {} };

/* ---------- render ---------- */
function render(data){
  document.getElementById('title').textContent = data.title || 'Вправа';
  document.getElementById('v-num').textContent = state.id;
  const gt = document.getElementById('germanText');
  gt.innerHTML = (data.germanText || '').replace(/\n/g,'<br>');
  document.getElementById('explanation').textContent = data.explanation || '';

  // vocab
  const vWrap = document.getElementById('vocab');
  vWrap.innerHTML = (data.vocabulary||[]).map((it,idx)=>`
    <div class="v-item">
      <label for="v-${idx}"><b>${escapeHTML(it.word)}</b></label>
      <input class="input vocab-input" id="v-${idx}" data-answer="${escapeHTML(it.answer)}" placeholder="Українською…" />
    </div>`).join('');

  // comp 3.1
  const c31 = document.getElementById('comp31');
  c31.innerHTML = (data.comprehension3_1||[]).map(row=>{
    let i=0;
    const html = row.textParts.map(p => p==="INPUT" ? `<input class="input inline-input comp31" data-answer="${escapeHTML(row.answers[i++])}" placeholder="…">`
                                                    : `<span>${escapeHTML(p)}</span>`).join(' ');
    return `<div class="card"><p style="margin:0">${html}</p></div>`;
  }).join('');

  // comp 3.2
  const c32 = document.getElementById('comp32');
  c32.innerHTML = (data.comprehension3_2||[]).map((q,idx)=>`
    <div class="v-item">
      <label for="a-${idx}">${escapeHTML(q.question)}</label>
      <textarea id="a-${idx}" class="input comp32" rows="2" data-answer="${escapeHTML(q.answer)}" placeholder="Ваша відповідь…"></textarea>
    </div>`).join('');

  // restore saved answers
  restoreProgress();
  updateScoreUI();
}

/* ---------- data ---------- */
async function loadData(){
  const idParam = parseInt(qs('v', '1'), 10);
  state.id = Number.isFinite(idParam) && idParam>=1 && idParam<=14 ? idParam : 1;
  const url = `data/exercises/${pad2(state.id)}.json`;
  try{
    const res = await fetch(url, {cache:'reload'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    window.currentExercise = json; // (для налагодження)
    render(json);
  }catch(e){
    document.getElementById('title').textContent = 'Помилка завантаження';
    document.getElementById('germanText').innerHTML = `<span class="small">Не вдалося отримати <code>${url}</code>. Переконайтесь, що файл існує на GitHub Pages (шлях чутливий до регістру).</span>`;
    console.error('Load error:', e);
  }
}

/* ---------- progress (localStorage) ---------- */
const key = () => `dp-ex-${pad2(state.id)}`;
function saveProgress(){
  const data = {
    translation: document.getElementById('translationInput')?.value || '',
    vocab: Array.from(document.querySelectorAll('.vocab-input')).map(i=>i.value),
    comp31: Array.from(document.querySelectorAll('.comp31')).map(i=>i.value),
    comp32: Array.from(document.querySelectorAll('.comp32')).map(i=>i.value),
  };
  try{ localStorage.setItem(key(), JSON.stringify(data)); }catch(_){}
}
function restoreProgress(){
  try{
    const raw = localStorage.getItem(key());
    if(!raw) return;
    const obj = JSON.parse(raw);
    document.getElementById('translationInput').value = obj.translation || '';
    document.querySelectorAll('.vocab-input').forEach((i,k)=> i.value = obj.vocab?.[k] || '');
    document.querySelectorAll('.comp31').forEach((i,k)=> i.value = obj.comp31?.[k] || '');
    document.querySelectorAll('.comp32').forEach((i,k)=> i.value = obj.comp32?.[k] || '');
  }catch(_){}
}

/* ---------- scoring ---------- */
function updateScoreUI(){
  const v = pad2(state.id);
  const s = state.scores[v] || {vocab:0, c31:0, c32:0};
  const comp = (s.c31 + s.c32)/2;
  const overall = (s.vocab + comp)/2;
  document.getElementById('score-vocab').textContent = s.vocab ? `${s.vocab.toFixed(0)}%` : '';
  document.getElementById('score-comp').textContent = comp ? `${comp.toFixed(0)}%` : '';
  document.getElementById('overall').textContent = `${(isFinite(overall)?overall:0).toFixed(0)}%`;
}

/* ---------- wiring ---------- */
document.addEventListener('click', e=>{
  if(e.target.id==='m-close' || e.target.id==='modal') hideModal();
});
document.addEventListener('input', e=>{
  if(e.target.matches('textarea, .input')) saveProgress();
});

// buttons
document.addEventListener('click', e=>{
  // copy german
  if(e.target.id==='copyGermanBtn'){
    const t = document.getElementById('germanText').innerText.trim();
    navigator.clipboard?.writeText(t).then(()=> {
      e.target.textContent = 'Скопійовано!';
      setTimeout(()=> e.target.textContent='Копіювати текст', 1200);
    });
  }

  // check translation (self-check)
  if(e.target.id==='checkTranslationBtn'){
    const data = window.currentExercise || {};
    const user = (document.getElementById('translationInput').value || '').trim();
    showModal('Результат перекладу', `
      <h4 style="margin:0 0 8px">Ваш переклад</h4>
      <p class="card" style="white-space:pre-wrap">${escapeHTML(user||'(порожньо)')}</p>
      <h4 style="margin:14px 0 8px">Зразок</h4>
      <p class="card" style="background:#e6f5f0">${escapeHTML(data.correctTranslation||'(немає зразка)')}</p>
    `);
    document.getElementById('score-translation').textContent = 'Самоперевірка';
  }

  // check vocabulary
  if(e.target.id==='checkVocabBtn'){
    const inputs = document.querySelectorAll('.vocab-input');
    let ok=0, details='<ul style="list-style:none;padding-left:0;display:grid;gap:8px">';
    inputs.forEach(inp=>{
      const user = norm(inp.value);
      const goldRaw = (inp.dataset.answer||'').split(',').map(s=>s.trim()).filter(Boolean);
      const gold = goldRaw.map(norm);
      const hit = gold.some(g=>g && (user===g || user.includes(g) || g.includes(user)));
      if(hit){ ok++; details += `<li>✅ <b>${escapeHTML(inp.previousElementSibling?.textContent||'')}</b> — ${escapeHTML(inp.value)}</li>`; }
      else{
        const pretty = goldRaw.map(g=>`<code>${escapeHTML(g)}</code>`).join(', ');
        details += `<li>❌ <b>${escapeHTML(inp.previousElementSibling?.textContent||'')}</b><br>Ваша: “${escapeHTML(inp.value||'')}”<br>Приклад: ${pretty||'—'}</li>`;
      }
    });
    details+='</ul>';
    const score = inputs.length ? (ok/inputs.length)*100 : 0;
    const k = pad2(state.id);
    state.scores[k] = state.scores[k] || {};
    state.scores[k].vocab = score;
    updateScoreUI();
    showModal('Результати словникової вправи', `<p><b>Правильно:</b> ${ok} з ${inputs.length} (${score.toFixed(0)}%)</p>${details}`);
  }

  // check comprehension
  if(e.target.id==='checkCompBtn'){
    const blanks = document.querySelectorAll('.comp31');
    let ok31=0; blanks.forEach(inp=>{
      if(normStrict(inp.value) === normStrict(inp.dataset.answer||'')) ok31++;
    });
    const s31 = blanks.length ? (ok31/blanks.length)*100 : 0;

    const answers = document.querySelectorAll('.comp32');
    let ok32=0; answers.forEach(inp=>{
      const gold = keyWords(inp.dataset.answer);
      const said = keyWords(inp.value);
      const hits = said.filter(w=>gold.includes(w)).length;
      if(said.length>0 && hits>=Math.min(2, gold.length)) ok32++;
    });
    const s32 = answers.length ? (ok32/answers.length)*100 : 0;

    const k = pad2(state.id);
    state.scores[k] = state.scores[k] || {};
    state.scores[k].c31 = s31; state.scores[k].c32 = s32;
    updateScoreUI();

    showModal('Результати вправ на розуміння', `
      <p>3.1 (доповнення): ${ok31} з ${blanks.length} (${s31.toFixed(0)}%)</p>
      <p>3.2 (відповіді): ${ok32} з ${answers.length} (${s32.toFixed(0)}%)</p>
    `);
  }
});

// close modal by Esc
document.addEventListener('keydown', e=>{ if(e.key==='Escape') hideModal(); });

/* ---------- init ---------- */
loadData();
</script>

<!--
=== Приклад JSON-схеми: data/exercises/01.json ===
{
  "title": "Das Maschinensystem für die Tierproduktion",
  "germanText": "Абзац 1...\\n\\nАбзац 2...",
  "explanation": "sich befassen mit (D) — займатися чим-небудь",
  "correctTranslation": "Еталонний переклад (українською)...",
  "vocabulary": [
    {"word":"sich befassen (mit)","answer":"займатися чим-небудь"},
    {"word":"die Einrichtung","answer":"обладнання, устаткування"}
  ],
  "comprehension3_1": [
    {"textParts":["1) Zur Entmistung der ","INPUT"," mit ","INPUT"," …"],"answers":["Ställe","Einstreu"]}
  ],
  "comprehension3_2": [
    {"question":"1) Які підсистеми входять...","answer":"...Fütterung, Entmistung, Reinigung und Desinfektion, Melken."}
  ]
}
-->
</body>
</html>
